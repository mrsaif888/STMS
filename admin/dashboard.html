<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="../assets/style.css" />
  <body>
    <div class="admin-dashboard">
      <h1>Admin Dashboard</h1>
      <div class="dashboard-grid">
        <div class="dashboard-left">
      <div class="admin-section create-user">
        <h2>Create New User</h2>
        <form id="create-user-form">
            <input type="text" id="new-username" />
            <input type="password" id="new-password" />
            <select id="new-role">
              <option value="user">User</option>
            </select>
          <button type="submit">Create User</button>
        </form>
      </div>
  
      <div class="admin-section assign-team-lead">
        <h2>Assign Team Lead</h2>
        <select id="team-lead-selection"></select>
        <button id="assign-team-lead-btn">Assign as Team Lead</button>
      </div>
  </div>
  <div class="dashboard-right">
      <div class="admin-section create-task">
  <h2>Create Task</h2>
  <form id="create-task-form">
    <input type="text" id="task-title" placeholder="Task Title" required>
    <textarea id="task-desc" placeholder="Task Description"></textarea>
    <input type="date" id="task-deadline" required>
    
    <select id="task-priority" required>
      <option value="high">High Priority</option>
      <option value="medium">Medium Priority</option>
      <option value="low">Low Priority</option>
    </select>

    <select id="task-assign" required>
      <!-- Users loaded dynamically here -->
    </select>

    <button type="submit">Create Task</button>
  </form>
</div>

  
      <div class="admin-section task-board">
        <h2>Task Board</h2>
        <div class="kanban-board">
          <div class="kanban-column" id="todo"><h3>To Do</h3></div>
          <div class="kanban-column" id="in-progress"><h3>In Progress</h3></div>
          <div class="kanban-column" id="completed"><h3>Completed</h3></div>
        </div>
      </div>
    </div>
    </div>
    </div>

  <script>
    // create-user-form

    document.getElementById("create-user-form").addEventListener("submit", function (e) {
      e.preventDefault();
    
      const username = document.getElementById("new-username").value;
      const password = document.getElementById("new-password").value;
      const role = document.getElementById("new-role").value;
    
      fetch("../backend/create_user.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&role=${encodeURIComponent(role)}`
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) {
          document.getElementById("create-user-form").reset();
          loadUsersForTeamLead(); // Optional: reload team lead dropdown
        }
      })
      .catch(err => {
        console.error("User creation error:", err);
        alert("Something went wrong.");
      });
    });
// assign team lead

    document.addEventListener("DOMContentLoaded", () => {
  const assignBtn = document.getElementById("assign-team-lead-btn");
  if (assignBtn) {
    assignBtn.addEventListener("click", function () {
      const selectedUserId = document.getElementById("team-lead-selection").value;

      fetch("../backend/assign_team_lead.php", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `user_id=${encodeURIComponent(selectedUserId)}`
      })
        .then(res => res.json())
        .then(data => {
          alert(data.message);
          if (data.success) loadUsersForTeamLead();
        })
        .catch(err => {
          console.error("Assign failed:", err);
        });
    });
  } else {
    console.warn("⚠️ Button not found in DOM.");
  }

  loadUsersForTeamLead();
});


// create task


document.addEventListener("DOMContentLoaded", () => {
  // ✅ Task creation form
  const taskForm = document.getElementById("create-task-form");

  if (taskForm) {
    taskForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const data = {
        title: document.getElementById("task-title").value,
        description: document.getElementById("task-desc").value,
        deadline: document.getElementById("task-deadline").value,
        priority: document.getElementById("task-priority").value,
        assigned_to: document.getElementById("task-assign").value
      };

      console.log("Sending task data to backend:", data);

      fetch("../backend/create_task.php", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams(data)
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message);
        console.log("Task Created:", result);
      })
      .catch(err => {
        console.error("Task creation failed:", err);
        alert("Error creating task.");
      });
    });
  } else {
    console.warn("❗ Form not found in DOM.");
  }
});



function loadUsersForTeamLead() {
    fetch("../backend/get_users_for_teamlead.php")
    .then(res => res.json())
    .then(data => {
      console.log("Fetched users:", data.users); // ✅ log the array

      const dropdown = document.getElementById("team-lead-selection");
      console.log("Dropdown element:", dropdown); // ✅ check if it exists

      if (!dropdown) {
        alert("Dropdown not found. Check the ID!");
        return;
      }

      dropdown.innerHTML = "";

      if (data.users.length === 0) {
        const option = document.createElement("option");
        option.textContent = "No users available";
        option.disabled = true;
        dropdown.appendChild(option);
        return;
      }

      data.users.forEach(user => {
        const option = document.createElement("option");
        option.value = user.id;
        option.textContent = user.username;
        dropdown.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Failed to load users:", err);
    });
}
function loadUsersForTaskAssign() {
    fetch("../backend/get_users_for_task.php")
    .then(res => res.json())
    .then(data => {
      const dropdown = document.getElementById("task-assign");
      dropdown.innerHTML = "";

      if (data.users.length === 0) {
        const option = document.createElement("option");
        option.textContent = "No users found";
        option.disabled = true;
        dropdown.appendChild(option);
        return;
      }

      data.users.forEach(user => {
        const option = document.createElement("option");
        option.value = user.id;
        option.textContent = `${user.username} (${user.role})`;
        dropdown.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Failed to load users for task assign:", err);
    });
}
window.addEventListener("DOMContentLoaded", () => {
  loadUsersForTaskAssign(); // 👈 Load team leads + users into dropdown
});
    </script>
      </body>
</html>
